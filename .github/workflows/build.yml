name: Build and Push
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. Pull the code from your repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Log in to DockerHub (using the correct action)
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.MY_DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build and Push in a single step to keep variables alive
      - name: Build and Push Image
        run: |
          # Use your DockerHub USERNAME here, not your email!
          # We force it to lowercase just to be safe.
          DOCKER_USER=$(echo "${{ vars.MY_DOCKER_USER }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="$DOCKER_USER/my-app"
          TAG="${{ github.sha }}"
          
          echo "Building $IMAGE_NAME:$TAG..."
          
          docker build -t "$IMAGE_NAME:$TAG" -t "$IMAGE_NAME:latest" .
          
          echo "Pushing to DockerHub..."
          docker push "$IMAGE_NAME:$TAG"
          docker push "$IMAGE_NAME:latest"
